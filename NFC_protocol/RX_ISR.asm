;/INCLUDES----------------------------------------------------------------------------------------------------------------------------
	.cdecls C, LIST, "../common/globals.h","_14443_B.h"
	.define "0", SR_SP_OFF
;Register Defs
R_rxBuf         .set R4     		; Point to rx_buffer, 16 bits
R_currentByte   .set R5     		; Store currentByte, R5: 16 bits
R_bits          .set R6     		; Store the number of receiving bits, 16 bits
R_currentBit    .set R7     		; Store current bit position, 16 bits
R_sum           .set R8     		; Store current bits + num of receiving bits, 16 bits
R_debug         .set R9
;/************************************************************************************************************************************
;*                                 PORT 1 ISR (Starting a Command Receive)                                                           *
;* Theory: RX ISR Will perform two different functions:                                                                              *
;*       - #1: RX ISR triggers on rising edge that indicates the beginning of frame to wakeup the RX. It will then wakeup RX          *
;*                                                                                                                                   *
;*       - #2: RX ISR triggers on rising edge that indicates the end of a delimiter. It then sets up TA1 Capture for triggering the  *
;*               remaining data bits.                                                												 *
;*                                                                    																 *
;* @Note: If incorrect delimiter is found, then wakeup from LMP3 and waiting for the next reading round                      		 *
;* 		  max 14+66=82 cpu cycles, max measured delay is 6us
;
;*************************************************************************************************************************************/
RX_ISR:								; [X] t=76ns @13.56Mhz
;*********************************************************************************************************************************
; Select ISR handler
;********************************************************************************************************************************
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ADD    &P1IV,    PC					; [2]
  RETI								; [2] Vecotr 0
  JMP    Other_HND					; [2] Port1 bit0
  JMP    Other_HND					; [2] Port1 bit1
  JMP    RX_WAKEUP_ISR				; [2] Port1 bit2
  JMP    RX_HND						; [2] Port1 bit3
  JMP    Other_HND					; [2] Port1 bit4
  JMP    Other_HND					; [2] Port1 bit5
  JMP    Other_HND					; [2] Port1 bit6
  JMP    Other_HND					; [2] Port1 bit6
  JMP    ACELL_INT1_HND				; [2] Port1 bit7

RX_HND:
  MOV   &TA0R,	R_bits				; [2] Move counted cycles into bits buffer
; MOV	&TA0R,	R_debug				; DEBUG: Store current TAR0 value into R_debug
  CLR   &TA0R

; MODIFIED: Add new parts to fix the problem of very short 0s and very long 1s, start from here......
  BIT.B #RX_BIT,	&RX_IES			; MODIFIED: If detected 0 at rising edge, received zeros, add zDt
  JNZ   Increment_Ones				; MODIFIED: If detected 1 at falling edge(eob), received ones, add Dt
  ADD.B #zDt,	R_bits				; MODIFIED: Add tolorence to R_bits
  JMP	RX_HND_CONTINUE				; MODIFIED: Jump over Increment_Ones

Increment_Ones:
  ADD.B #Dt,	R_bits

RX_HND_CONTINUE:
; MODIFIED: Newly added parts, end here
; ADD.B #Dt,    R_bits				; [2] Add tolorence to R_bits
  CLR.B &RX_IFG						; [2] Clear port 1 flag
; XOR.B #LED_1_BIT, &LED_1_OUT		; [2] DEBUG
  BIT.B #NFC_Rx2,  &doNFC_state		; [3] Detected current state
  JNZ ReadBits
  BIT.B #NFC_Rx1,  &doNFC_state
  JNZ TestSOF
  BIT.B #NFC_Rx0,  &doNFC_state
  JNZ TestDelim
Other_HND:
  CLR.B &RX_IFG
  CLR.B &RX_IE
  RETI

;*********************************************************************************************************************************
; decoding bits (max) doNFC_state = NFC_Rx2
;*********************************************************************************************************************************
ReadBits:
; MOV.B R_bits,	R_debug				; [2] DEBUG
  RRA   R_bits						; [2] Shift right by 4(R_bits/16) to get the number of bits received currently
  RRA   R_bits
  RRA   R_bits
  RRA   R_bits
  JZ	WAKEUP_ISR					; [2] Not valid bits wake up
  CMP.B #10, R_bits
; JGE	WAKE_UP_LPM4				; [2] Not valid bits wake up

; MODIFIED: newly added parts, startfrom here......
  JGE	CheckEdge					; MODIFIED: Added for the new phone
  JMP	ReadBitsContinue			; MODIFIED: If not jumping to checkedge, jump to continue readbits

CheckEdge:
  BIT.B #RX_BIT,	&RX_IES			; MODIFIED: If detect 0 at rising edge, eof, jump to WAKE_UP_LPM4
  JNZ   ReadBitsContinue			; MODIFIED: If detect 1 at falling edge, eob, jump to ReadBitsContinue
  JMP 	WAKE_UP_LPM4				; MODIFIED: Added for the new phone

ReadBitsContinue:
; MODIFIED: newly added parts, end here

  CMP.B  #0, R_currentBit			; [2]
  JEQ    StartOfByte
  MOV.B R_currentBit, R_sum			; [2] The sum of the number of bits received till now (current+received);
  ADD.B R_bits,	R_sum				; [2]
  CMP.B #9,		R_sum				; [2] R_temp<9?
  JL Update_bits					; [2] If R_sum<9, jump
  MOV.B #9,		R_sum
  MOV.B #9,		R_bits
  SUB.B R_currentBit, R_bits		; [4] R_bits = 9 - R_currentBit

Update_bits:
  MOV.B R_sum, R_currentBit			; [2] Update R_currentBit to be either 9 or R_bits+R_currentBit
  BIT.B #RX_BIT, &RX_IES			; [2] Jump if receive 1
  JNZ ShiftloopAdd

Shiftloop:
  RRA R_currentByte					; [2] Must be RRA not RRA.B
  SUB.B #1, R_bits					; [2] R_bits - 1
  JNZ Shiftloop
  JMP EndByte

ShiftloopAdd:
  RRA  R_currentByte				; [2] Shift right and add 1
  ADD.B #0x80,    R_currentByte		; [2] Add 1 to the MSB
  SUB.B #1, R_bits					; [2] R_bits - 1
  JNZ ShiftloopAdd
  JMP EndByte

StartOfByte:
  BIT.B #RX_BIT,  &RX_IES			; [2] If detect 0 at rising edge
  JNZ   EndByte						; [2] If detect 1 at falling edge, jump to EndByte
  MOV.B #0x00,    R_currentByte		; [2] Clear current Byte buffer
  MOV.B R_bits,   R_currentBit		; [2] CurrentBit is R_bits

EndByte:
  XOR.B #RX_BIT,	&RX_IES			; [2] Toggle edge
; XOR.B #LED_2_BIT, &LED_2_OUT		; [2] DEBUG: indication
  CMP.B #9,		R_currentBit    	; [2] DEBUG: MODIFY might need to change 9 to 10, change it to a variable, if old phone:9, of new phone:10
  JNZ End_HND
; RRA R_currentByte					; DEBUG: Add this line for the new phone, since EGT was counted
  MOV.B R_currentByte, 0(R_rxBuf)	; [4] Update current rx_buffer
  INC.W R_rxBuf
  ADD.B #1,       &_14443_buf_ptr	; [2]
  CLR.B R_currentBit
; XOR.B #LED_2_BIT, &LED_2_OUT		; [2] DEBUG: indication
End_HND:
  RETI

;*********************************************************************************************************************************
; TestSOF (max 14) doNFC_state = NFC_Rx1
;*********************************************************************************************************************************
TestSOF:
  AND.B #0xF0,R_bits				; [2]
  CMP.B #0x20,R_bits				; [2]
  JEQ   ValidSOF					; [1] Jump if R_bits==2 cycles @106k

WAKEUP_ISR:
  CLR.B  &RX_IFG					; [2] Clear Port1 flag
  CLR.B  &validRx					; [2] validRx
WAKE_UP_LPM4:
  MOV.B #7, &debug_interrupt							; DEBUG: DEBUGGING INTERRUPT
  BIC    #(SCG1+SCG0+OSCOFF+CPUOFF+GIE), SR_SP_OFF(SP)	; [4] Wake up from LPM4
  RETI

ValidSOF:
  MOV.B #EOF, &TA0CCR0				; [2]
  BIC.B #RX_BIT,  &RX_IES			; [2] Rising edge
  MOV.B #NFC_Rx2, &doNFC_state		; [2] Set BIT2 in doNFC_state
  RETI

;*********************************************************************************************************************************
; TestDelim (max 13 cycles) doNFC_state = NFC_Rx0
;*********************************************************************************************************************************
TestDelim:
  CMP.B #SOF, R_bits				; [2]
  JL    WAKEUP_ISR					; [2] Jump R_bits<SOF
  BIS.B #RX_BIT,  &RX_IES			; [2] Falling edge
  MOV.B #THREE_PULSES,  &TA0CCR0	; [2] TIMEOUT is 3 pulses@106k
  BIS.B #BIT0,      &validRx		; [2] Set flag
  MOV.W #(rx_buffer), R_rxBuf 		; [2] Load the rx_buffer to the reg!
  CLR.B R_currentBit				; [2]
  MOV.B #NFC_Rx1,   &doNFC_state	; [2] Set NFC_Rx1 in doNFC_state
  RETI

;*********************************************************************************************************************************
; Detect edges in either sleep_till_read or sleep_till_edge (max 14) doNFC_state = BIT4/BIT3
;*********************************************************************************************************************************
RX_WAKEUP_ISR:
  MOV.B  #NFC_Start,  &doNFC_state	; [3] If doNFC_state = Sleep now then go to NFC_Start, it is RX_WAKEUP_ISR
; CLR.B	 &imageState				; [2] Halt image update
  CLR.B  &RX_WAKEUP_IFG				; [2] Clear port1 flag
; BIC.B	 #CCIE,  &TA1CCTL0
  MOV.B  #8, &debug_interrupt		; DEBUG: DEBUGGING INTERRUPT
  BIC    #(0xF8), SR_SP_OFF(SP)		; [4] Wake up from LPM4
  RETI
ACELL_INT1_HND:
  ;***********************************************************************************************************************************
  ;Accelerometer activity or in-activity state
  ; each time detect interrupt leftshit accel_state, if detect activity add 1
  ;***********************************************************************************************************************************
  ADD.B #1, &accelState						; Leftsheft the previous one
; BIT.B #ACCEL_INT1_BIT &ACCEL_INT1_IES
; JNZ resetHND
; ADD.B #1 &accelState						; Detect activity so add one to it
  BIC.B #ACCEL_INT1_BIT, &ACCEL_INT1_IFG	; Clear interrupt
; XOR.B #ACCEL_INT1_BIT,  &ACCEL_INT1_IES	; Toggle actibity state
  BIT.B #NFC_LPM4, &doNFC_state				; If it is in NFC_LPM4 mode
  JZ	return
resetHND:
  MOV.B #NFC_Sleep,	&doNFC_state			; Continious set it to be sleep after update ADC
  BIC    #(0xF8), SR_SP_OFF(SP)				; [4] Wake up from LPM4 and disable GIE
return:
  RETI
;*************************************************************************************************************************************
; DEFINE THE INTERRUPT VECTOR ASSIGNMENT                                               *
;*************************************************************************************************************************************
  .sect ".int47"			; Port 1 Vector
  .short  RX_ISR			; This sect/short pair sets int02 = RX_ISR addr.
  .end
